(function(){var e={},p=exports.flags={enableLocalScope:!1},g=function(){void 0===g.value&&(g.value=-1);return++g.value},q=function(a){for(var b in e)if(e[b].page===a)return e[b]},l=[];exports.virtualAddon=function(){var a={},b={},c={port:{emit:function(a,c){var e=b[a];if(void 0!==e)for(var m=0,f;f=e[m];m++)f(c)},on:function(b,c){void 0===a[b]&&(a[b]=[]);a[b].push(c)}},lib:{emit:function(b,c){var e=a[b];if(void 0!==e)for(var f=0,g;g=e[f];f++)g(c)},on:function(a,c){void 0===b[a]&&(b[a]=[]);b[a].push(c)}},
isVirtual:!0};l.push(c);return c};exports.virtualPort=function(){window.addEventListener("message",function(a){">"===a.data[0]&&(a=JSON.parse(a.data.substr(1)),self.port.emit("mono",a))});self.port.on("mono",function(a){a="<"+JSON.stringify(a);a=new CustomEvent("monoMessage",{detail:a});window.dispatchEvent(a)})};var r=function(a){var b=a.page;if(!b.isVirtual){var c=function(){a.active=!0},d=function(){a.active=!1};b.on("attach",function(){a.active=!0;e[a.id]=a;b.on("pageshow",c);b.on("pagehide",
d)});b.on("detach",function(){delete e[a.id];a.active=!1;b.off("pageshow",c);b.off("pagehide",d)})}},k={activeTab:function(a){var b=require("sdk/tabs").activeTab,c=[],d;for(d in e)e[d].page.tab===b&&e[d].page.url===b.url&&c.push(e[d].id);if(0!==c.length)for(b=0;d=c[b];b++)a.to=d,f(a)},popupWin:function(a){var b="resource://"+require("sdk/self").id.slice(1,-1)+"/",c,d;for(d in e){var h=e[d].page;if(void 0!==h.isShowing&&null===h.tab&&0===h.url.indexOf(b)){c=e[d].id;break}}void 0!==c&&(a.to=c,f(a))}},
f=function(a){if(void 0!==a.hook){var b=k[a.hook];if(void 0!==b)return delete a.hook,b(a)}if(void 0!==a.to){var c=e[a.to];return c&&!1!==c.active?c.page[void 0!==c.page.isVirtual?"lib":"port"].emit("mono",a):void 0}for(var b=e[a.from],c=0,d;d=l[c];c++)b.page!==d&&d.lib.emit("mono",a);if(p.enableLocalScope&&void 0!==b&&b.page.isVirtual&&void 0!==a.from)for(var h in e)c=e[h],b!==c&&!1!==c.isLocal&&!1!==c.active&&c.page.port.emit("mono",a)},t=require("sdk/self").data.url().match(/([^:]+:\/\/[^/]+)\//)[1];
exports.addPage=function(a){var b=q(a);b||(b={page:a,id:g(),active:!0,isLocal:void 0===a.isVirtual&&a.url&&0===a.url.indexOf(t)},e[b.id]=b,r(b),a[void 0!==a.isVirtual?"lib":"port"].on("mono",function(a){a.from=b.id;f(a)}))};var n=function(){var a=require("sdk/simple-storage");return{get:function(b,c){var d,e={};if(void 0===b||null===b){for(d in a.storage)a.storage.hasOwnProperty(d)&&(e[d]=a.storage[d]);return c(e)}"string"===typeof b&&(b=[b]);if(!0===Array.isArray(b))for(var f=0,g=b.length;f<g;f++)d=
b[f],a.storage.hasOwnProperty(d)&&(e[d]=a.storage[d]);else for(d in b)a.storage.hasOwnProperty(d)&&(e[d]=a.storage[d]);c(e)},set:function(b,c){for(var d in b)a.storage[d]=b[d];c&&c()},remove:function(b,c){if(Array.isArray(b))for(var d=0,e=b.length;d<e;d++)delete a.storage[b[d]];else delete a.storage[b];c&&c()},clear:function(b){for(var c in a.storage)delete a.storage[c];b&&b()}}}();exports.storage=n;k.monoStorage=function(a){var b=a.data||{},c=function(b){void 0!==a.callbackId&&(b={data:b,to:a.from,
responseId:a.callbackId},f(b))},d=n[b.action];void 0!==d&&("clear"===b.action?d(c):d(b.data,c))};var u=exports.serviceList={resize:function(a){var b=e[a.from];b&&!1!==b.active&&(a=a.data||{},a.width&&(b.page.width=a.width),a.height&&(b.page.height=a.height))},openTab:function(a){a=a.data||{};var b=require("sdk/self");require("sdk/tabs").open(a.dataUrl?b.data.url(a.url):a.url)}};k.service=function(a){var b=function(b){void 0!==a.callbackId&&(b={data:b,to:a.from,responseId:a.callbackId},f(b))},c=u[(a.data||
{}).action];void 0!==c&&c(a,b)}})();
